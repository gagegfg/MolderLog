<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LogiTrack Móvil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body { font-family: sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen pb-safe">

    <!-- PANTALLA DE CARGA -->
    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-bold">Cargando Ruta...</p>
    </div>

    <!-- VISTA: SIN VIAJE -->
    <div id="no-trip-view" class="hidden min-h-screen flex flex-col items-center justify-center p-6">
        <div class="bg-blue-100 p-6 rounded-full mb-6"><i data-lucide="truck" class="w-12 h-12 text-blue-600"></i></div>
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Hola, <span id="driver-name">Chofer</span></h1>
        <p class="text-slate-500 mb-8 text-center">¿Listo para comenzar la jornada?</p>
        <button onclick="startTrip()" class="w-full py-4 bg-blue-600 text-white rounded-xl text-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-3">
            <i data-lucide="play"></i> INICIAR VIAJE
        </button>
        <button onclick="logout()" class="mt-8 text-red-500 text-sm font-medium">Cerrar Sesión</button>
    </div>

    <!-- VISTA: EN RUTA -->
    <div id="active-trip-view" class="hidden">
        <!-- Header -->
        <div class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-10">
            <div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="font-bold text-slate-800">En Ruta</span>
                </div>
                <p class="text-xs text-slate-400" id="trip-start-time">...</p>
            </div>
            <button onclick="endTrip()" class="px-3 py-1 border border-red-200 text-red-500 rounded-full text-xs font-bold">FINALIZAR</button>
        </div>

        <div class="p-4 space-y-6">
            <!-- BOTÓN PRINCIPAL -->
            <div id="main-action-area"></div>

            <!-- HISTORIAL -->
            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Historial de Hoy</h3>
                <div id="stops-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // ### CONFIGURACIÓN DE SUPABASE ###
        // =================================================================
        const SUPABASE_URL = 'TU_URL_DE_SUPABASE_AQUI';
        const SUPABASE_KEY = 'TU_CLAVE_ANON_KEY_AQUI';
        // =================================================================

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        lucide.createIcons();

        let currentUser = null;
        let currentTrip = null;
        let currentStop = null;

        // INICIO
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return window.location.href = 'login.html';
            
            // Obtener perfil
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            currentUser = profile;
            document.getElementById('driver-name').textContent = profile.full_name.split(' ')[0];

            await refreshState();
        });

        async function refreshState() {
            document.getElementById('loader').classList.remove('hidden');
            
            // Buscar viaje activo
            const { data: trips } = await supabaseClient.from('trips').select('*').eq('driver_id', currentUser.id).eq('status', 'active').limit(1);
            currentTrip = trips?.[0] || null;

            if (currentTrip) {
                document.getElementById('no-trip-view').classList.add('hidden');
                document.getElementById('active-trip-view').classList.remove('hidden');
                document.getElementById('trip-start-time').textContent = 'Inicio: ' + new Date(currentTrip.start_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                // Buscar Paradas
                const { data: stops } = await supabaseClient.from('stops').select('*').eq('trip_id', currentTrip.id).order('arrival_time', {ascending: false});
                
                // Render Historial
                const list = document.getElementById('stops-list');
                list.innerHTML = stops.filter(s => s.departure_time).map(s => `
                    <div class="bg-white p-4 rounded-xl border-l-4 border-green-500 shadow-sm">
                        <div class="font-bold text-slate-800">${s.client_name || 'Punto Logístico'}</div>
                        <div class="text-xs text-slate-500 flex gap-2 mt-1">
                            <span><i data-lucide="clock" class="inline w-3"></i> ${s.wait_time_minutes ? Math.round(s.wait_time_minutes) + ' min' : '-'}</span>
                            <span>|</span>
                            <span>${s.type.toUpperCase()}</span>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-gray-400 text-sm py-4">Aún no hay paradas.</p>';

                // Estado Botón Principal
                const openStop = stops.find(s => !s.departure_time);
                currentStop = openStop;
                renderMainButton();
            } else {
                document.getElementById('no-trip-view').classList.remove('hidden');
                document.getElementById('active-trip-view').classList.add('hidden');
            }
            
            document.getElementById('loader').classList.add('hidden');
            lucide.createIcons();
        }

        function renderMainButton() {
            const container = document.getElementById('main-action-area');
            if (!currentStop) {
                container.innerHTML = `
                    <div class="bg-blue-600 text-white p-6 rounded-2xl text-center shadow-lg shadow-blue-200">
                        <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-3 animate-pulse"><i data-lucide="map-pin" class="w-8 h-8"></i></div>
                        <h2 class="text-2xl font-bold mb-1">¿Llegaste al punto?</h2>
                        <p class="text-blue-100 text-sm mb-6">Registra tu llegada para iniciar la descarga.</p>
                        <button onclick="registerArrival()" class="w-full py-4 bg-white text-blue-600 rounded-xl font-bold text-lg shadow active:scale-95 transition-transform">MARCAR LLEGADA</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="bg-white border-2 border-blue-500 p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center gap-2 text-blue-600 font-bold mb-4 border-b pb-4"><i data-lucide="clock" class="animate-spin"></i> Descargando en curso...</div>
                        <div class="space-y-3">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Cliente / Punto</label>
                            <input id="client-name" type="text" class="w-full p-3 border rounded-lg bg-gray-50" placeholder="Ej: Arcor, Planta...">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Tipo</label>
                            <select id="stop-type" class="w-full p-3 border rounded-lg bg-gray-50">
                                <option value="delivery">Entrega Cliente</option>
                                <option value="pickup">Retiro</option>
                                <option value="internal">Interno</option>
                            </select>
                        </div>
                        <button onclick="registerDeparture()" class="w-full mt-6 py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow active:scale-95 transition-transform">FINALIZAR Y SALIR</button>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        async function startTrip() {
            if(!confirm("¿Iniciar nueva ruta?")) return;
            document.getElementById('loader').classList.remove('hidden');
            await supabaseClient.from('trips').insert({ driver_id: currentUser.id, status: 'active' });
            await refreshState();
        }

        async function registerArrival() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                await supabaseClient.from('stops').insert({
                    trip_id: currentTrip.id,
                    arrival_time: new Date().toISOString(),
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                });
                await refreshState();
            }, () => alert("Error GPS"), {enableHighAccuracy: true});
        }

        async function registerDeparture() {
            const clientName = document.getElementById('client-name').value;
            if(!clientName) return alert("Ingresa el nombre del cliente");
            await supabaseClient.from('stops').update({
                departure_time: new Date().toISOString(),
                client_name: clientName,
                type: document.getElementById('stop-type').value
            }).eq('id', currentStop.id);
            await refreshState();
        }

        async function endTrip() {
            if(!confirm("¿Finalizar la jornada?")) return;
            await supabaseClient.from('trips').update({ status: 'completed', end_time: new Date().toISOString() }).eq('id', currentTrip.id);
            await refreshState();
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
