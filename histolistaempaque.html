<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Histórico de Listas de Empaque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Scripts para Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-image: url('fondo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .backdrop-blur-lg {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        th { cursor: pointer; }
        .sort-icon {
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        th:hover .sort-icon {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="static-loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4 font-sans z-50">
        <div class="relative bg-[#D2B48C]/20 backdrop-blur-lg border border-[#D2B48C]/30 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <img src="logo.jpg" alt="Logo Molderil" class="mx-auto mb-6 h-32 [filter:drop-shadow(2px_2px_4px_rgba(0,0,0,0.4))_drop_shadow(-2px_-2px_4px_rgba(255,255,255,0.6))]"/>
            <p id="loader-status" class="text-xl text-white mb-4 [text-shadow:_1px_1px_2px_rgba(0,0,0,0.5)]">Cargando aplicación...</p>
            <div class="w-full bg-white/20 rounded-full h-4 border border-white/30">
                <div id="loader-progress" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
            </div>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        // --- INICIALIZACIÓN DE SUPABASE ---
        let supabaseClient;
        if (typeof supabase !== 'undefined' && typeof SUPABASE_URL !== 'undefined' && typeof SUPABASE_KEY !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.log(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.log(error);
                }
            };
            return [storedValue, setValue];
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="relative p-6 bg-white w-full max-w-md rounded-xl shadow-lg m-4">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">{title}</h3>
                        <p className="text-gray-700 mb-6 whitespace-pre-wrap">{message}</p>
                        <div className="flex justify-end space-x-4">
                            <button onClick={onCancel} className="bg-gray-300 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-400">
                                Cancelar
                            </button>
                            <button onClick={onConfirm} className="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700">
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditDispatchModal = ({ isOpen, item, onClose, onSave }) => {
            const [fecha, setFecha] = useState('');
            const [transporte, setTransporte] = useState('');
            const [retira, setRetira] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                if (item && isOpen) {
                    const fetchDispatchData = async () => {
                        setIsLoading(true);
                        const { data, error } = await supabaseClient
                            .from('despachoListaEmpaque')
                            .select('fechaDespacho, razonSocialTransporte, retiranDesdePlanta')
                            .eq('idListaEmpaque', item.idlista)
                            .single();

                        if (error) { // No se encontró el registro
                            console.warn('No dispatch data found for idlista:', item.idlista, error.message);
                            setFecha('');
                            setTransporte('');
                            setRetira(false);
                        } else if (data) { // Se encontró el registro
                            setFecha(data.fechaDespacho || '');
                            setTransporte(data.razonSocialTransporte || '');
                            setRetira(data.retiranDesdePlanta || false);
                        }
                        setIsLoading(false);
                    };

                    fetchDispatchData();
                }
            }, [item, isOpen]);

            if (!isOpen || !item) return null;

            const handleSave = () => {
                onSave({
                    idlista: item.idlista,
                    fecha,
                    transporte,
                    retira
                });
            };

            const isFormInvalid = !fecha || !transporte.trim();

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Editar Datos de Despacho</h2>
                        <div className="mb-6 bg-gray-50 p-4 rounded-lg border">
                            <p className="text-sm text-gray-600">ID Lista: <span className="font-semibold text-black">{item.idlista}</span></p>
                            <p className="text-sm text-gray-600">Cliente: <span className="font-semibold text-black">{item.Cliente}</span></p>
                        </div>
                        {isLoading ? (
                            <div className="h-48 flex items-center justify-center">
                                <i className="fas fa-sync-alt animate-spin text-4xl text-gray-400"></i>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="fecha-despacho" className="block text-sm font-medium text-gray-700 mb-1">Fecha de Despacho</label>
                                    <input
                                        type="date"
                                        id="fecha-despacho"
                                        value={fecha}
                                        onChange={e => setFecha(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="transporte" className="block text-sm font-medium text-gray-700 mb-1">Transporte</label>
                                    <input
                                        type="text"
                                        id="transporte"
                                        value={transporte}
                                        onChange={e => setTransporte(e.target.value.toUpperCase())}
                                        className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                        placeholder="Nombre del transporte"
                                    />
                                </div>
                                <div className="flex items-center">
                                    <input
                                        id="retira-planta"
                                        type="checkbox"
                                        checked={retira}
                                        onChange={e => setRetira(e.target.checked)}
                                        className="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    />
                                    <label htmlFor="retira-planta" className="ml-2 block text-sm text-gray-900">El transporte retira en planta</label>
                                </div>
                            </div>
                        )}
                        <div className="flex justify-end space-x-4 mt-8">
                            <button onClick={onClose} className="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button onClick={handleSave} disabled={isLoading || isFormInvalid} className="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-3xl h-5/6 flex flex-col">
                    <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Guía de Usuario: Histórico de Listas</h3>
                    <div className="flex-grow overflow-y-auto pr-2 space-y-6 text-gray-700">
                        
                        <div>
                            <h4 className="font-bold text-lg text-indigo-700 flex items-center"><i className="fas fa-search w-6 mr-2"></i>Búsqueda y Filtrado</h4>
                            <ul className="list-disc list-inside mt-2 space-y-2 pl-4">
                                <li><strong>Búsqueda Global:</strong> Utiliza el campo "Búsqueda global..." para encontrar texto en cualquier parte de la tabla.</li>
                                <li><strong>Filtros por Columna:</strong> Debajo de cada título de columna, hay un campo para filtrar específicamente por ese dato.</li>
                                <li><strong>Filtro por Fechas:</strong> Usa los campos "Desde" y "Hasta" para acotar los registros por su fecha de creación.</li>
                                <li><strong>Limpiar Filtros:</strong> El botón <i className="fas fa-times-circle"></i> "Limpiar Filtros" borra todas las búsquedas y fechas.</li>
                            </ul>
                        </div>

                        <div>
                            <h4 className="font-bold text-lg text-indigo-700 flex items-center"><i className="fas fa-eye w-6 mr-2"></i>Visualización</h4>
                            <ul className="list-disc list-inside mt-2 space-y-2 pl-4">
                                <li><strong>Ordenar:</strong> Haz clic en el título de cualquier columna para ordenar la tabla por ese dato.</li>
                                <li><strong>Agrupación:</strong> Las filas están agrupadas por lista de empaque. Una línea azul más gruesa indica el comienzo de una nueva lista.</li>
                                <li><strong>Paginación:</strong> Usa los controles en la parte superior para navegar entre páginas y cambiar cuántos registros ves a la vez.</li>
                            </ul>
                        </div>

                        <div>
                            <h4 className="font-bold text-lg text-indigo-700 flex items-center"><i className="fas fa-pencil-alt w-6 mr-2"></i>Acciones de Edición</h4>
                            <p className="mt-1 pl-4">Cada fila tiene un menú de acciones (<i className="fas fa-ellipsis-v"></i>) en la última columna. Desde allí puedes:</p>
                            <ul className="list-disc list-inside mt-2 space-y-2 pl-8">
                                <li>
                                    <strong><i className="fas fa-truck-loading text-blue-500 w-6 mr-1"></i>Editar Despacho:</strong> Abre una ventana para cambiar la fecha, el transporte y si retira en planta. Ambos campos son obligatorios para guardar.
                                </li>
                                <li>
                                    <strong><i className="fas fa-minus-circle text-yellow-600 w-6 mr-1"></i>Eliminar Pallet de la Lista:</strong> Quita un solo pallet (una fila) de la lista de empaque. La lista y el pallet seguirán existiendo, solo se borra la relación entre ellos.
                                </li>
                                <li>
                                    <strong><i className="fas fa-trash-alt text-red-600 w-6 mr-1"></i>Eliminar Lista Completa:</strong> Borra permanentemente la lista de empaque y todos sus pallets asociados. Esta acción no se puede deshacer.
                                </li>
                            </ul>
                        </div>

                    </div>
                    <div className="flex justify-end mt-6">
                        <button onClick={onClose} className="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Entendido</button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [data, setData] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isGridLoading, setIsGridLoading] = useState(false);

            const [columnFilters, setColumnFilters] = useState({});
            const [internalColumnFilters, setInternalColumnFilters] = useState({});
            const [globalFilter, setGlobalFilter] = useState('');
            const [debouncedGlobalFilter, setDebouncedGlobalFilter] = useState('');
            const [fechaDesde, setFechaDesde] = useState('');
            const [fechaHasta, setFechaHasta] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'idlista', direction: 'descending' });
            
            const [currentPage, setCurrentPage] = useState(1);
            const [recordsPerPage, setRecordsPerPage] = useLocalStorage('histo_recordsPerPage', 100);
            const [totalRecords, setTotalRecords] = useState(0);

            const [isExportOpen, setIsExportOpen] = useState(false);
            const exportMenuRef = useRef(null);
            const [activeActionMenu, setActiveActionMenu] = useState(null);
            const actionMenuRef = useRef(null);

            const [modalState, setModalState] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const [editModalState, setEditModalState] = useState({ isOpen: false, item: null });
            const [showHelpModal, setShowHelpModal] = useState(false);
            
            const displayHeaders = useMemo(() => {
                if (headers.length === 0) return [];
                
                const preferredOrder = [
                    'idlista', 'Legajo', 'Fecha Creacion lista', 'Cliente', 
                    'Lotes de produccion', 'Sku', 'descripcion sku', 'nro de pallet', 
                    'Fecha de produccion', 'cantidad', 'U.M.'
                ];
                
                return [...headers]
                    .filter(h => h !== 'fechacreacion') // Ocultar la columna de fecha original
                    .sort((a, b) => {
                        const indexA = preferredOrder.indexOf(a);
                        const indexB = preferredOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return 0;
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
            }, [headers]);

            const applyFiltersToQuery = (query) => {
                if (debouncedGlobalFilter && headers.length > 0) {
                    const orFilter = headers
                        .filter(h => h !== 'fechacreacion') // No incluir la columna de fecha original en el filtro global
                        .map(header => {
                            const h = /[\\s.]/.test(header) ? `"${header}"` : header;
                            return `${h}.ilike.%${debouncedGlobalFilter}%`;
                        })
                        .join(',');
                    query = query.or(orFilter);
                }

                Object.keys(columnFilters).forEach(key => {
                    const filterValue = columnFilters[key] ? columnFilters[key].trim() : '';
                    if (filterValue) {
                        const h = /[\\s.]/.test(key) ? `"${key}"` : key;
                        query = query.ilike(h, `%${filterValue}%`);
                    }
                });

                // Usar la columna de fecha original para el filtro de rango
                if (fechaDesde) query = query.gte('fechacreacion', fechaDesde);
                if (fechaHasta) {
                    const nextDay = new Date(fechaHasta);
                    nextDay.setDate(nextDay.getDate() + 1);
                    const nextDayString = nextDay.toISOString().split('T')[0];
                    query = query.lt('fechacreacion', nextDayString);
                }

                const sortKey = sortConfig.key;
                const h = /[\\s.]/.test(sortKey) ? `"${sortKey}"` : sortKey;
                query = query.order(h, { ascending: sortConfig.direction === 'ascending' });
                
                return query;
            };

            const loadData = useCallback(async (isManualRefresh = false) => {
                if (!supabaseClient) {
                    alert("La configuración de Supabase no está disponible.");
                    setIsLoading(false);
                    return;
                }
                setIsGridLoading(true);

                try {
                    let query = supabaseClient.from('vista_historial_listas_empaque').select('*', { count: 'exact' });
                    query = applyFiltersToQuery(query);
                    
                    const page = isManualRefresh ? 1 : currentPage;
                    const rangeFrom = (page - 1) * recordsPerPage;
                    const rangeTo = rangeFrom + recordsPerPage - 1;
                    query = query.range(rangeFrom, rangeTo);

                    const { data: resultData, error, count } = await query;

                    if (error) throw error;

                    if (resultData && resultData.length > 0 && headers.length === 0) {
                        const parsedHeaders = Object.keys(resultData[0]);
                        setHeaders(parsedHeaders);
                        const initialFilters = {};
                        parsedHeaders.forEach(h => initialFilters[h] = '');
                        setColumnFilters(initialFilters);
                        setInternalColumnFilters(initialFilters);
                    }
                    
                    setData(resultData.map((row, index) => ({...row, uniqueId: `row-${page}-${index}`})));
                    setTotalRecords(count || 0);

                } catch (error) {
                    console.error('Error cargando datos desde Supabase:', error);
                    alert(`Error al cargar el historial: ${error.message}`);
                } finally {
                    setIsGridLoading(false);
                    if (isLoading) setIsLoading(false);
                }
            }, [supabaseClient, columnFilters, debouncedGlobalFilter, fechaDesde, fechaHasta, sortConfig, currentPage, recordsPerPage, headers]);

            // Initial load and dependency-driven reloads
            useEffect(() => {
                if (!isLoading) {
                     loadData(true); // Force reset to page 1 on filter change
                }
            }, [columnFilters, debouncedGlobalFilter, fechaDesde, fechaHasta, sortConfig, recordsPerPage]);

            useEffect(() => {
                if (!isLoading) {
                    loadData(false); // Load specific page
                }
            }, [currentPage]);

            useEffect(() => {
                const initializeApp = async () => {
                    const loader = document.getElementById('static-loader');
                    document.getElementById('loader-status').textContent = "Cargando histórico...";
                    document.getElementById('loader-progress').style.width = '66%';
                    
                    await loadData(true);
                    
                    document.getElementById('loader-status').textContent = "¡Listo!";
                    document.getElementById('loader-progress').style.width = '100%';
                    setTimeout(() => {
                        if (loader) {
                            loader.classList.add('opacity-0');
                            setTimeout(() => loader.remove(), 500);
                        }
                    }, 500);
                };
                
                if (supabaseClient) {
                    initializeApp();
                } else {
                    // Handle missing supabase config
                }
            }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) setIsExportOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // Debounce for column filters
            useEffect(() => {
                const handler = setTimeout(() => {
                    if (JSON.stringify(internalColumnFilters) !== JSON.stringify(columnFilters)) {
                        setColumnFilters(internalColumnFilters);
                    }
                }, 500);
                return () => { clearTimeout(handler); };
            }, [internalColumnFilters, columnFilters]);

            // Debounce for global filter
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedGlobalFilter(globalFilter);
                }, 500);
                return () => { clearTimeout(handler); };
            }, [globalFilter]);

            const handleColumnFilterChange = (columnId, value) => {
                setInternalColumnFilters(prev => ({ ...prev, [columnId]: value }));
            };
            
            const handleSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const clearFilters = () => {
                const clearedFilters = {};
                headers.forEach(h => clearedFilters[h] = '');
                setColumnFilters(clearedFilters);
                setInternalColumnFilters(clearedFilters);
                setFechaDesde('');
                setFechaHasta('');
                setGlobalFilter('');
                if (currentPage !== 1) setCurrentPage(1);
            };

            const handleDeleteList = (idlista) => {
                setModalState({
                    isOpen: true,
                    title: 'Confirmar Eliminación de Lista',
                    message: `¿Estás seguro de que quieres eliminar la lista de empaque completa N° ${idlista}? Esta acción es irreversible y borrará todos sus pallets asociados.`,
                    onConfirm: async () => {
                        const { error } = await supabaseClient.rpc('borrar_lista_empaque_completa', { id_lista_a_borrar: idlista });
                        if (error) {
                            alert(`Error al eliminar la lista: ${error.message}`);
                        } else {
                            loadData(true);
                        }
                        setModalState({ isOpen: false });
                    }
                });
            };

            const handleDeleteItem = (item) => {
                setModalState({
                    isOpen: true,
                    title: 'Confirmar Eliminación de Pallet',
                    message: `¿Estás seguro de que quieres eliminar el pallet N° ${item['nro de pallet']} de la lista N° ${item.idlista}?`,
                    onConfirm: async () => {
                        const { error } = await supabaseClient.rpc('borrar_item_lista_empaque_por_pallet', { p_idlista: item.idlista, p_nropallet: item['nro de pallet'] });
                        if (error) {
                            alert(`Error al eliminar el pallet: ${error.message}`);
                        } else {
                            loadData(true);
                        }
                        setModalState({ isOpen: false });
                    }
                });
            };

            const handleOpenEditModal = (item) => {
                setEditModalState({ isOpen: true, item: item });
            };

            const handleSaveDispatch = async (dispatchData) => {
                const { error } = await supabaseClient.rpc('actualizar_despacho_lista_empaque', {
                    p_idlista: dispatchData.idlista,
                    p_fecha_despacho: dispatchData.fecha,
                    p_transporte: dispatchData.transporte,
                    p_retira_planta: dispatchData.retira
                });

                if (error) {
                    alert(`Error al actualizar los datos de despacho: ${error.message}`);
                } else {
                    setEditModalState({ isOpen: false, item: null });
                    loadData(true);
                }
            };

            const fetchAllFilteredData = async () => {
                setIsGridLoading(true);
                try {
                    let query = supabaseClient.from('vista_historial_listas_empaque').select('*');
                    query = applyFiltersToQuery(query);
                    const { data, error } = await query;
                    if (error) throw error;
                    return data;
                } catch (error) {
                    alert(`Error al preparar la exportación: ${error.message}`);
                    return null;
                } finally {
                    setIsGridLoading(false);
                }
            };

            const exportToPDF = async () => {
                const allExportData = await fetchAllFilteredData();
                if (!allExportData) return;
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.text("Histórico de Listas de Empaque", 14, 16);
                doc.autoTable({ head: [displayHeaders], body: allExportData.map(item => displayHeaders.map(header => item[header] || '')), startY: 22 });
                doc.save("historico_listas_empaque.pdf");
                setIsExportOpen(false);
            };

            const exportToExcel = async () => {
                const allExportData = await fetchAllFilteredData();
                if (!allExportData) return;
                const excelData = allExportData.map(item => {
                    const rowObject = {};
                    displayHeaders.forEach(header => { rowObject[header] = item[header]; });
                    return rowObject;
                });
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Histórico");
                XLSX.writeFile(workbook, "historico_listas_empaque.xlsx");
                setIsExportOpen(false);
            };
            
            const getColumnClasses = (header) => {
                let classes = 'px-3 py-2 text-sm text-gray-700 align-middle';
                switch(header.toLowerCase()) {
                    case 'idlista':
                    case 'legajo':
                        return `${classes} w-20 font-semibold text-gray-900 whitespace-nowrap`;
                    case 'fecha creacion lista':
                        return `${classes} w-40 whitespace-nowrap`;
                    case 'cantidad':
                    case 'u.m.':
                        return `${classes} w-24 text-center`;
                    default:
                        return classes;
                }
            };

            return (
                <div className="h-screen p-4 sm:p-6 bg-black bg-opacity-50 flex flex-col">
                    <ConfirmationModal 
                        isOpen={modalState.isOpen}
                        title={modalState.title}
                        message={modalState.message}
                        onConfirm={modalState.onConfirm}
                        onCancel={() => setModalState({ isOpen: false })}
                    />
                    <EditDispatchModal
                        isOpen={editModalState.isOpen}
                        item={editModalState.item}
                        onClose={() => setEditModalState({ isOpen: false, item: null })}
                        onSave={handleSaveDispatch}
                    />
                    {showHelpModal && <HelpModal onClose={() => setShowHelpModal(false)} />}
                    <div className="bg-white p-6 rounded-2xl shadow-xl flex flex-col flex-grow">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-gray-200">
                            <div className="flex items-center space-x-4">
                                <h1 className="text-3xl font-extrabold text-gray-800">Histórico de Listas de Empaque</h1>
                                <button onClick={() => setShowHelpModal(true)} title="Ayuda" className="text-gray-400 hover:text-indigo-600 transition-colors">
                                    <i className="fas fa-question-circle text-2xl"></i>
                                </button>
                            </div>
                            <div className="flex items-center space-x-3 mt-4 sm:mt-0">
                                <a href="grillaqr.html" className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-sm flex items-center"><i className="fas fa-qrcode mr-2"></i>Trazabilidad Lotes</a>
                                <a href="listaempaque.html" className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors shadow-sm flex items-center"><i className="fas fa-barcode mr-2"></i>Crear Lista Empaque</a>
                                <a href="index.html" className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Menú Principal</a>
                            </div>
                        </div>
                        
                        <div className="flex flex-wrap gap-y-2 justify-between items-center mb-4 p-4 border rounded-lg bg-gray-50">
                            {/* Left side controls */}
                            <div className="flex flex-wrap items-center gap-x-4 gap-y-2">
                                <input 
                                    type="text" 
                                    value={globalFilter}
                                    onChange={e => setGlobalFilter(e.target.value)}
                                    placeholder="Búsqueda global..."
                                    className="p-2 border border-gray-300 rounded-md shadow-sm w-48"
                                />
                                <div className="flex items-center gap-x-2">
                                    <label className="text-sm font-medium text-gray-700">Desde:</label>
                                    <input type="date" value={fechaDesde} onChange={e => setFechaDesde(e.target.value)} className="rounded-md border-gray-300 shadow-sm p-2 border"/>
                                </div>
                                <div className="flex items-center gap-x-2">
                                    <label className="text-sm font-medium text-gray-700">Hasta:</label>
                                    <input type="date" value={fechaHasta} onChange={e => setFechaHasta(e.target.value)} className="rounded-md border-gray-300 shadow-sm p-2 border"/>
                                </div>
                                <span className="text-sm font-medium text-gray-700 px-2">
                                    Página {currentPage} de {totalRecords > 0 ? Math.ceil(totalRecords / recordsPerPage) : 1}
                                </span>
                            </div>

                            {/* Right side controls */}
                            <div className="flex flex-wrap items-center gap-x-4 gap-y-2">
                                <button onClick={clearFilters} className="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 flex items-center">
                                    <i className="fas fa-times-circle mr-2"></i>Limpiar Filtros
                                </button>

                                <div className="flex items-center space-x-2">
                                    <label htmlFor="recordsPerPage" className="text-sm font-medium text-gray-700">Ver:</label>
                                    <select id="recordsPerPage" value={recordsPerPage} onChange={e => { setRecordsPerPage(Number(e.target.value)); }} className="rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                        <option value={50}>50</option>
                                        <option value={100}>100</option>
                                        <option value={200}>200</option>
                                        <option value={400}>400</option>
                                    </select>
                                </div>

                                <div className="flex items-center space-x-1">
                                    <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1 || isGridLoading} className="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-3 rounded-lg shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i className="fas fa-chevron-left"></i>
                                    </button>
                                    <button onClick={() => setCurrentPage(p => p + 1)} disabled={currentPage * recordsPerPage >= totalRecords || isGridLoading} className="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-3 rounded-lg shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i className="fas fa-chevron-right"></i>
                                    </button>
                                </div>

                                <button onClick={() => loadData(true)} disabled={isGridLoading} className="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50 flex items-center">
                                    <i className={`fas fa-sync-alt ${isGridLoading ? 'animate-spin' : ''} mr-2`}></i>Refrescar
                                </button>

                                <div className="relative" ref={exportMenuRef}>
                                    <button onClick={() => setIsExportOpen(prev => !prev)} disabled={data.length === 0} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                                        <i className="fas fa-download mr-2"></i>Exportar<i className={`fas fa-chevron-down ml-2 transition-transform ${isExportOpen ? 'rotate-180' : ''}`}></i>
                                    </button>
                                    {isExportOpen && (
                                        <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-20"><ul className="text-gray-700">
                                            <li><button onClick={exportToPDF} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-pdf w-6 mr-2 text-red-500"></i>a PDF</button></li>
                                            <li><button onClick={exportToExcel} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-excel w-6 mr-2 text-green-500"></i>a Excel</button></li>
                                        </ul></div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="overflow-auto rounded-lg shadow-md border flex-grow min-h-0">
                             {isGridLoading && (
                                <div className="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-20">
                                    <div className="flex items-center space-x-3 text-xl font-semibold text-gray-700 bg-white p-4 rounded-lg shadow-lg">
                                        <i className="fas fa-sync-alt animate-spin"></i>
                                        <span>Cargando...</span>
                                    </div>
                                </div>
                            )}
                            <table className={`min-w-full divide-y divide-gray-200 table-auto ${isGridLoading ? 'opacity-50' : ''}`}>
                                <thead className="bg-gray-800 text-white sticky top-0 z-10">
                                    <tr>
                                        {displayHeaders.map(header => (<th key={header} className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider" onClick={() => handleSort(header)}>
                                            <div className="flex items-center">{header}<i className={`fas ${sortConfig.key === header ? (sortConfig.direction === 'ascending' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'} ml-2 sort-icon`}></i></div>
                                        </th>))}
                                        <th className="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">Acciones</th>
                                    </tr>
                                    <tr className="bg-gray-200">
                                        {displayHeaders.map(header => (<th key={`filter-${header}`} className="p-1"><input type="text" placeholder="Filtrar..." value={internalColumnFilters[header] || ''} onChange={e => handleColumnFilterChange(header, e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        ))}
                                        <th className="p-1"></th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {isLoading ? (<tr><td colSpan={displayHeaders.length + 1} className="p-8 text-center text-gray-500">Cargando...</td></tr>) 
                                    : ( data.length > 0 ? data.map((item, index) => {
                                        const prevItem = index > 0 ? data[index - 1] : null;
                                        const isNewList = !prevItem || prevItem.idlista !== item.idlista;
                                        const rowClasses = `group hover:bg-blue-50 ${isNewList && index > 0 ? 'border-t-2 border-blue-300' : ''}`;

                                        return (
                                            <tr key={item.uniqueId} className={rowClasses}>
                                                {displayHeaders.map(header => {
                                                    const content = item[header];
                                                    const lowerCaseHeader = header.toLowerCase();
                                                    const isLotesColumn = lowerCaseHeader === 'lotes de produccion';

                                                    if (isLotesColumn && content) {
                                                        const values = String(content).split('#');
                                                        return (
                                                            <td key={`${item.uniqueId}-${header}`} className={getColumnClasses(header)}>
                                                                <div className="flex flex-wrap gap-1">
                                                                    {values.filter(value => value && value.trim() !== '').map((value, i) => (
                                                                        <span key={`${item.uniqueId}-${header}-${i}`} className='px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-200 text-gray-800'>
                                                                            {value.trim()}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </td>
                                                        );
                                                    }
                                                    
                                                    return (
                                                        <td key={`${item.uniqueId}-${header}`} className={getColumnClasses(header)}>
                                                            {content}
                                                        </td>
                                                    );
                                                })}
                                                <td className="px-2 py-2 text-center align-middle">
                                                    <div className="relative" ref={activeActionMenu === item.uniqueId ? actionMenuRef : null}>
                                                        <button onClick={(e) => { e.stopPropagation(); setActiveActionMenu(activeActionMenu === item.uniqueId ? null : item.uniqueId); }} className="text-gray-500 hover:text-blue-600 p-2 rounded-full">
                                                            <i className="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        {activeActionMenu === item.uniqueId && (
                                                            <div className="absolute right-full mr-2 mt-[-2rem] w-64 bg-white rounded-md shadow-lg border z-30">
                                                                <ul className="text-gray-700 text-left">
                                                                    <li><button onClick={() => { handleOpenEditModal(item); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-truck-loading w-6 mr-2 text-blue-500"></i>Editar Despacho</button></li>
                                                                    <li><hr className="my-1"/></li>
                                                                    <li><button onClick={() => { handleDeleteItem(item); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-minus-circle w-6 mr-2 text-yellow-600"></i>Eliminar Pallet de la Lista</button></li>
                                                                    <li><button onClick={() => { handleDeleteList(item.idlista); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-trash-alt w-6 mr-2 text-red-600"></i>Eliminar Lista Completa</button></li>
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    }) : (<tr><td colSpan={displayHeaders.length + 1} className="p-8 text-center text-gray-500">No se encontraron registros.</td></tr>)
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>