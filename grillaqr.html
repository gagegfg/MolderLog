<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Histórico de Lotes (Sincronizado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
          background-image: url('fondo.jpg');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          background-attachment: fixed;
        }
        .backdrop-blur-lg {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="static-loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4 font-sans z-50">
        <div class="relative bg-[#D2B48C]/20 backdrop-blur-lg border border-[#D2B48C]/30 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
          <img src="logo.jpg" alt="Logo Molderil" class="mx-auto mb-6 h-32 [filter:drop-shadow(2px_2px_4px_rgba(0,0,0,0.4))_drop_shadow(-2px_-2px_4px_rgba(255,255,255,0.6))]"/>
          <p id="loader-status" class="text-xl text-white mb-4 [text-shadow:_1px_1px_2px_rgba(0,0,0,0.5)]">Cargando aplicación...</p>
          <div class="w-full bg-white/20 rounded-full h-4 border border-white/30">
            <div id="loader-progress" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
          </div>
        </div>
    </div>

    <div id="root"></div>

    <script src="config.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.log(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.log(error);
                }
            };
            return [storedValue, setValue];
        };
        
        const NoteModal = ({ isOpen, text, onClose, onSave }) => {
            const textareaRef = useRef(null);
            const [currentText, setCurrentText] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setCurrentText(text || '');
                    setTimeout(() => {
                        textareaRef.current?.focus();
                    }, 100);
                }
            }, [isOpen, text]);

            if (!isOpen) return null;

            const handleSave = () => {
                onSave(currentText);
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Agregar/Editar Nota</h3>
                        <textarea
                            ref={textareaRef}
                            value={currentText}
                            onChange={e => setCurrentText(e.target.value)}
                            className="w-full h-40 p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                            placeholder="Escriba su nota aquí... Deje el campo vacío para eliminar la nota."
                        />
                        <div className="flex justify-end space-x-3 mt-6">
                            <button onClick={onClose} className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button onClick={handleSave} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Nota</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [supabaseClient, setSupabaseClient] = useState(null);
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [isGridLoading, setIsGridLoading] = useState(false);
            const [allData, setAllData] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            
            const [currentPage, setCurrentPage] = useState(1);
            const [recordsPerPage, setRecordsPerPage] = useLocalStorage('grillaqr_recordsPerPage', 400);
            const [totalRecords, setTotalRecords] = useState(0);

            const [modalState, setModalState] = useState({ isOpen: false, type: null, title: '', message: '', onConfirm: null });
            const [noteModal, setNoteModal] = useState({ isOpen: false, item: null, text: '' });
            const [observationModal, setObservationModal] = useState({ isOpen: false, text: '' });
            const [reprintModal, setReprintModal] = useState({ isOpen: false, pdfUrl: null, printablePdfUrl: null, palletId: null });
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [showPendingModal, setShowPendingModal] = useState(false);
            const [activeActionMenu, setActiveActionMenu] = useState(null);
            const actionMenuRef = useRef(null);
            const mobileMenuRef = useRef(null);

            const [isTransferMode, setIsTransferMode] = useState(false);
            const [transferSelection, setTransferSelection] = useState({});
            
            const [columnFilters, setColumnFilters] = useLocalStorage('grillaqr_columnFilters_v3', {
                sku: '',
                descripcion: '',
                numeroDePallet: '',
                lotesProduccion: '',
                despachado: '',
                cliente: ''
            });
            const [internalColumnFilters, setInternalColumnFilters] = useState(columnFilters);
            const [fechaDesde, setFechaDesde] = useState('');
            const [fechaHasta, setFechaHasta] = useState('');
            const [newDataAvailable, setNewDataAvailable] = useState(false);
            const [latestKnownUpdate, setLatestKnownUpdate] = useState(null);
            
            const [sortConfig, setSortConfig] = useState({ key: 'numeroDePallet', direction: 'descending' });

            const [isExportOpen, setIsExportOpen] = useState(false);
            const exportMenuRef = useRef(null);
            
            const longPressTimer = useRef(null);
            const touchDuration = 500; 

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const applyFiltersToQuery = (query) => {
                const keyMap = {
                    numeroDePallet: 'nropallet',
                    lotesProduccion: 'lotesproduccion',
                    fechaProduccion: 'fechaproduccion',
                    unidadMedida: 'unidadmedida',
                    isStored: 'is_transferred'
                };

                Object.keys(columnFilters).forEach(key => {
                    const filterValue = columnFilters[key] ? columnFilters[key].trim() : '';
                    if (filterValue) {
                        if (key === 'despachado') {
                            if ('sí'.startsWith(filterValue.toLowerCase())) query = query.eq('despachado', true);
                            else if ('no'.startsWith(filterValue.toLowerCase())) query = query.eq('despachado', false);
                        } else {
                            const dbKey = keyMap[key] || key;
                            const h = /[\s.]/.test(dbKey) ? `"${dbKey}"` : dbKey;
                            if (key === 'numeroDePallet' || key === 'nropallet') {
                                query = query.filter(h + '::text', 'ilike', `%${filterValue}%`);
                            } else {
                                query = query.ilike(h, `%${filterValue}%`);
                            }
                        }
                    }
                });

                if (fechaDesde && !isTransferMode) query = query.gte('fechaproduccion_filter', fechaDesde);
                if (fechaHasta && !isTransferMode) query = query.lte('fechaproduccion_filter', fechaHasta);
                if (isTransferMode) query = query.eq('is_transferred', false);

                const sortKeyRaw = keyMap[sortConfig.key] || sortConfig.key;
                const sortKey = /[\s.]/.test(sortKeyRaw) ? `"${sortKeyRaw}"` : sortKeyRaw;
                query = query.order(sortKey, { ascending: sortConfig.direction === 'ascending' });
                
                return query;
            };
            
            const loadData = useCallback(async (isManualRefresh = false) => {
                if (!supabaseClient) return;
                
                setIsGridLoading(true);

                try {
                    if (isManualRefresh) {
                        setNewDataAvailable(false);
                        const { data: maxDateData, error: maxDateError } = await supabaseClient
                            .from('vista_detallelotes_completa')
                            .select('updated_at')
                            .order('updated_at', { ascending: false })
                            .limit(1)
                            .single();
                        
                        if (maxDateError) {
                            console.error("Error fetching latest update timestamp:", maxDateError);
                        } else if (maxDateData) {
                            setLatestKnownUpdate(maxDateData.updated_at);
                        }
                    }

                    let query = supabaseClient.from('vista_detallelotes_completa').select('*', { count: 'exact' });

                    query = applyFiltersToQuery(query);
                    
                    const page = isManualRefresh ? 1 : currentPage;

                    const rangeFrom = (page - 1) * recordsPerPage;
                    const rangeTo = rangeFrom + recordsPerPage - 1;
                    query = query.range(rangeFrom, rangeTo);

                    const { data, error, count } = await query;

                    if (error) throw error;

                    const parsedLotes = data.map(item => ({
                        id: item.id,
                        sku: item.sku,
                        descripcion: item.descripcion,
                        numeroDePallet: item.nropallet,
                        lotesProduccion: item.lotesproduccion,
                        fechaProduccion: item.fechaproduccion_filter.split('-').reverse().join('/'),
                        cantidad: item.cantidad,
                        unidadMedida: item.unidadmedida,
                        cliente: item.cliente,
                        hasNote: item.has_note,
                        noteText: item.notatext || '',
                        despachado: item.despachado,
                        isStored: item.is_transferred,
                        updated_at: item.updated_at
                    }));
                    
                    setAllData(parsedLotes);
                    setTotalRecords(count || 0);

                } catch (error) {
                    console.error("Error cargando datos:", error);
                    setModalState({ isOpen: true, type: 'alert', title: 'Error de Carga', message: `No se pudieron cargar los datos: ${error.message}` });
                } finally {
                    setIsGridLoading(false);
                }
            }, [supabaseClient, columnFilters, fechaDesde, fechaHasta, sortConfig, currentPage, recordsPerPage, isTransferMode]);

            useEffect(() => {
                const staticLoader = document.getElementById('static-loader');
                const loaderStatus = document.getElementById('loader-status');
                const loaderProgress = document.getElementById('loader-progress');

                const setLoaderError = (message) => {
                    if (loaderStatus) {
                        loaderStatus.textContent = message;
                        loaderStatus.className = 'text-xl text-red-400 mb-4 [text-shadow:_1px_1px_2px_rgba(0,0,0,0.5)]';
                    }
                    if (loaderProgress) {
                        loaderProgress.style.width = '100%';
                        loaderProgress.classList.remove('bg-amber-400');
                        loaderProgress.classList.add('bg-red-600');
                    }
                    console.error(message);
                };

                if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_KEY === 'undefined' || !SUPABASE_URL.startsWith('https')) {
                    setLoaderError('ERROR: Revisa la configuración de Supabase en config.js.');
                    return;
                }

                const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                setSupabaseClient(client);

                const loadingTasks = [
                    { status: "Inicializando...", duration: 300, progress: 20 },
                    { status: "Conectando a la base de datos...", duration: 500, progress: 40 },
                    { 
                        status: "Calculando rango de fechas...", 
                        duration: 500,
                        progress: 60, 
                        action: async () => {
                            const today = new Date().toISOString().split('T')[0];
                            setFechaHasta(today);

                            const currentYear = new Date().getFullYear();
                            const startOfYear = `${currentYear}-01-01`;

                            const { data, error } = await client
                              .from('vista_detallelotes_completa')
                              .select('fechaproduccion')
                              .eq('despachado', false)
                              .gte('fechaproduccion', startOfYear)
                              .order('fechaproduccion', { ascending: true })
                              .limit(1)
                              .single();
                            
                            if (error) console.error("Error fetching min date:", error);
                            
                            setFechaDesde(data?.fechaproduccion || today);
                        }
                    },
                    { status: "Cargando datos...", duration: 1000, progress: 80 },
                    { status: "¡Listo!", duration: 500, progress: 100 }
                ];

                let currentTask = 0;
                const runLoadingTask = async () => {
                    if (currentTask < loadingTasks.length) {
                        const task = loadingTasks[currentTask];
                        if (loaderStatus) loaderStatus.textContent = task.status;
                        if (loaderProgress) loaderProgress.style.width = `${task.progress}%`;
                        if (task.action) await task.action();
                        
                        setTimeout(() => {
                            currentTask++;
                            runLoadingTask();
                        }, task.duration);
                    } else {
                        if (staticLoader) {
                            staticLoader.classList.add('opacity-0');
                            setTimeout(() => {
                                staticLoader.style.display = 'none';
                                setAppIsLoading(false);
                            }, 500);
                        }
                    }
                };
                runLoadingTask();
            }, []);

            const prevFilterDeps = useRef();
            useEffect(() => {
                const currentFilterDeps = JSON.stringify({
                    columnFilters, fechaDesde, fechaHasta, isTransferMode, sortConfig, recordsPerPage
                });

                let filtersHaveChanged = false;
                if (prevFilterDeps.current !== undefined) {
                    filtersHaveChanged = prevFilterDeps.current !== currentFilterDeps;
                }
                prevFilterDeps.current = currentFilterDeps;

                if (filtersHaveChanged) {
                    if (currentPage !== 1) {
                        setCurrentPage(1);
                        return; 
                    }
                }

                if (!appIsLoading) {
                    loadData(currentPage === 1);
                }
            }, [currentPage, columnFilters, fechaDesde, fechaHasta, isTransferMode, sortConfig, recordsPerPage, supabaseClient, appIsLoading]);

            useEffect(() => {
                if (!supabaseClient) return;
                const interval = setInterval(async () => {
                    if (document.hidden) return;

                    const { data: maxDateData, error: maxDateError } = await supabaseClient
                        .from('vista_detallelotes_completa')
                        .select('updated_at')
                        .order('updated_at', { ascending: false })
                        .limit(1)
                        .single();

                    if (maxDateError) {
                        console.error("Error checking for new data:", maxDateError);
                    } else if (maxDateData && latestKnownUpdate) {
                        const remoteTimestamp = new Date(maxDateData.updated_at).getTime();
                        const localTimestamp = new Date(latestKnownUpdate).getTime();
                        if (remoteTimestamp > localTimestamp) {
                            setNewDataAvailable(true);
                        }
                    } else if (maxDateData && !latestKnownUpdate) {
                        setNewDataAvailable(true);
                    }
                }, 60000);

                return () => clearInterval(interval);
            }, [latestKnownUpdate, supabaseClient]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) setIsExportOpen(false);
                    if (actionMenuRef.current && !actionMenuRef.current.parentElement.contains(event.target)) setActiveActionMenu(null);
                    if (mobileMenuRef.current && !mobileMenuRef.current.contains(event.target)) setIsMobileMenuOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // Debounce for column filters
            useEffect(() => {
                const handler = setTimeout(() => {
                    if (JSON.stringify(internalColumnFilters) !== JSON.stringify(columnFilters)) {
                        setColumnFilters(internalColumnFilters);
                    }
                }, 300);
                return () => { clearTimeout(handler); };
            }, [internalColumnFilters, columnFilters]);

            // Sync internal filters if external filters change (e.g., on clear)
            useEffect(() => {
                setInternalColumnFilters(columnFilters);
            }, [columnFilters]);



            const handleColumnFilterChange = (columnId, value) => {
                setInternalColumnFilters(prev => ({ ...prev, [columnId]: value }));
            };
            const clearFilters = () => {
                setColumnFilters({ sku: '', descripcion: '', numeroDePallet: '', lotesProduccion: '', despachado: '', cliente: '' });
                setFechaDesde('');
                setFechaHasta('');
                setCurrentPage(1);
            };

            const handleDeleteRow = (rowId) => {
                setModalState({
                    isOpen: true, type: 'confirm', title: `Confirmar Eliminación`,
                    message: `¿Seguro que quieres eliminar el pallet Nº ${rowId}? Si tiene una nota asociada, también se eliminará. Esta acción es irreversible.`,
                    onConfirm: async () => {
                        setModalState({ isOpen: false });
                        setIsSaving(true);
                        const { error } = await supabaseClient.rpc('delete_pallet_lot', { p_id_to_delete: rowId });
                        setIsSaving(false);
                        if (error) {
                            alert(`Error al eliminar: ${error.message}`);
                        } else {
                            loadData(true);
                        }
                    }
                });
            };
            
            const handleOpenNoteModal = (item) => {
                setNoteModal({
                    isOpen: true,
                    item: item,
                    text: item.noteText || ''
                });
            };

            const handleSaveNote = async (newText) => {
                const { item } = noteModal;
                const updatedText = newText.trim();

                setNoteModal({ isOpen: false, item: null, text: '' });
                setIsSaving(true);
                const { error } = await supabaseClient.rpc('upsert_note', {
                    p_nropallet: item.numeroDePallet,
                    p_notatext: updatedText
                });
                setIsSaving(false);

                if (error) {
                    alert(`Error al guardar la nota: ${error.message}`);
                } else {
                    loadData(true);
                }
            };

            const handleEnterTransferMode = () => {
                setIsTransferMode(true);
                setTransferSelection({});
            };
            
            const handleCancelTransferMode = () => {
                setIsTransferMode(false);
                setTransferSelection({});
            };

            const handleToggleTransferSelection = (itemId) => {
                setTransferSelection(prev => ({...prev, [itemId]: !prev[itemId]}));
            };

            const handleConfirmTransfer = async () => {
                const selectedItems = allData.filter(item => transferSelection[item.id]);
                if (selectedItems.length === 0) {
                    alert("No ha seleccionado ningún lote para transferir.");
                    return;
                }
                
                setModalState({
                    isOpen: true, type: 'confirm', title: 'Confirmar Transferencia',
                    message: `Está a punto de transferir ${selectedItems.length} lote(s) al depósito. ¿Desea continuar?`,
                    onConfirm: async () => {
                        setModalState({ isOpen: false });
                        setIsSaving(true);
                        const palletsToTransfer = selectedItems.map(item => item.numeroDePallet);
                        const { error } = await supabaseClient.rpc('transfer_pallets', { p_nropallets: palletsToTransfer });
                        setIsSaving(false);
                        if (error) {
                            alert(`Error al transferir: ${error.message}`);
                        } else {
                            await generateTransferPDF(selectedItems);
                            handleCancelTransferMode();
                            loadData(true);
                        }
                    }
                });
            };

            const loadImageAsDataURI = (url) => {
                return new Promise((resolve, reject) => {
                    const image = new Image();
                    image.crossOrigin = "Anonymous";
                    image.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = image.width;
                        canvas.height = image.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(image, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg'));
                    };
                    image.onerror = (error) => {
                        console.error("Error loading image for PDF:", error);
                        resolve(null);
                    };
                    image.src = url;
                });
            };

            const generateTransferPDF = async (transferredPallets) => {
                const doc = new jsPDF({ orientation: 'landscape' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 14;

                const logoDataUri = await loadImageAsDataURI('logo.jpg');

                if (logoDataUri) {
                    doc.addImage(logoDataUri, 'JPEG', margin, margin, 40, 15);
                }
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('Reporte de Transferencia de Pallets', pageWidth / 2, margin + 10, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Fecha de Generación: ${new Date().toLocaleString('es-AR')}`, pageWidth - margin, margin + 10, { align: 'right' });

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('Detalle de Pallets Transferidos', margin, 45);

                const detailHead = [["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "F. Prod.", "Cantidad", "U.M."]];
                const detailBody = transferredPallets.map(item => [
                    item.sku,
                    item.descripcion,
                    item.numeroDePallet,
                    item.lotesProduccion.replace(/#/g, ' '),
                    item.fechaProduccion,
                    item.cantidad,
                    item.unidadMedida
                ]);

                doc.autoTable({
                    startY: 50,
                    head: detailHead,
                    body: detailBody,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    margin: { left: margin, right: margin }
                });

                const summary = transferredPallets.reduce((acc, item) => {
                    if (!acc[item.sku]) {
                        acc[item.sku] = {
                            descripcion: item.descripcion,
                            cantidad: 0,
                            unidadMedida: item.unidadMedida
                        };
                    }
                    const cantidad = parseFloat(String(item.cantidad).replace(',', '.')) || 0;
                    acc[item.sku].cantidad += cantidad;
                    return acc;
                }, {});

                const summaryHead = [["SKU", "Descripción", "Cantidad Total", "U.M."]];
                const summaryBody = Object.keys(summary).map(sku => [
                    sku,
                    summary[sku].descripcion,
                    String(summary[sku].cantidad.toFixed(2)).replace('.', ','),
                    summary[sku].unidadMedida
                ]);

                let finalY = doc.lastAutoTable.finalY || 80;
                if (finalY > pageHeight - 50) {
                    doc.addPage();
                    finalY = margin;
                }

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('Resumen por SKU', margin, finalY + 15);

                doc.autoTable({
                    startY: finalY + 20,
                    head: summaryHead,
                    body: summaryBody,
                    theme: 'grid',
                    headStyles: { fillColor: [39, 174, 96], textColor: 255, fontStyle: 'bold' },
                    margin: { left: margin, right: margin }
                });

                const now = new Date();
                const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                const timeStr = String(now.getHours()).padStart(2, '0') + '-' + String(now.getMinutes()).padStart(2, '0') + '-' + String(now.getSeconds()).padStart(2, '0');
                const fileName = `reporte_transferencia_${dateStr}_${timeStr}.pdf`;
                doc.save(fileName);
            };

            const fetchAllFilteredData = async () => {
                setIsSaving(true);
                try {
                    let allResults = [];
                    const BATCH_SIZE = 1000;
                    let lastBatchLength = 0;
                    let page = 0;

                    do {
                        const rangeFrom = page * BATCH_SIZE;
                        const rangeTo = rangeFrom + BATCH_SIZE - 1;

                        let query = supabaseClient.from('vista_detallelotes_completa').select('*');
                        
                        query = applyFiltersToQuery(query);

                        query = query.range(rangeFrom, rangeTo);

                        const { data, error } = await query;

                        if (error) throw error;

                        allResults = allResults.concat(data);
                        lastBatchLength = data.length;
                        page++;

                    } while (lastBatchLength === BATCH_SIZE);
                    
                    return allResults.map(item => ({
                        id: item.id,
                        sku: item.sku,
                        descripcion: item.descripcion,
                        numeroDePallet: item.nropallet,
                        lotesProduccion: item.lotesproduccion,
                        fechaProduccion: new Date(item.fechaproduccion).toLocaleDateString('es-AR'),
                        cantidad: item.cantidad,
                        unidadMedida: item.unidadmedida,
                        despachado: item.despachado ? 'Sí' : 'No',
                        cliente: item.cliente ? item.cliente.replace(/#/g, ', ') : '',
                        hasNote: item.has_note,
                        isStored: item.is_transferred ? 'Sí' : 'No'
                    }));

                } catch (error) {
                    console.error("Error fetching all data for export:", error);
                    alert(`Error al preparar la exportación: ${error.message}`);
                    return null;
                } finally {
                    setIsSaving(false);
                }
            };

            const exportToPDF = async () => {
                const allExportData = await fetchAllFilteredData();
                if (!allExportData) return;

                const doc = new jsPDF({ orientation: 'landscape' });
                doc.setFontSize(18);
                doc.text("Histórico de Lotes Generados", 14, 16);
                const tableColumn = ["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "Despachado", "Cliente", "F. Prod.", "Cantidad", "U.M."];
                const tableRows = [];
                allExportData.forEach(item => {
                    const palletText = item.hasNote ? `${item.numeroDePallet} (*)` : item.numeroDePallet;
                    const rowData = [
                        item.sku, item.descripcion, palletText, item.lotesProduccion,
                        item.despachado, item.cliente, item.fechaProduccion, item.cantidad, item.unidadMedida
                    ];
                    tableRows.push(rowData);
                });
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 22, theme: 'grid', headStyles: { fillColor: [22, 160, 133] } });
                doc.save("historico_lotes.pdf");
                setIsExportOpen(false);
            };

            const exportToExcel = async () => {
                const allExportData = await fetchAllFilteredData();
                if (!allExportData) return;

                const excelData = allExportData.map(item => ({
                    'SKU': item.sku, 
                    'Descripción': item.descripcion, 
                    'Nº Pallet': item.hasNote ? `${item.numeroDePallet} (*)` : item.numeroDePallet,
                    'Lotes Producción': item.lotesProduccion, 
                    'Despachado': item.despachado,
                    'Cliente': item.cliente,
                    'Fecha Producción': item.fechaProduccion,
                    'Cantidad': item.cantidad, 
                    'Unidad Medida': item.unidadMedida,
                    'Almacenado': item.isStored
                }));
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Histórico");
                XLSX.writeFile(workbook, "historico_lotes.xlsx");
                setIsExportOpen(false);
            };
            
            const drawLabelOnDoc = async (doc, data) => {
                const pageW = 210; const margin = 8; const contentW = pageW - (margin * 2); let currentY = margin;
                doc.setFontSize(24); doc.setFont("helvetica", "bold"); doc.text("MOLDERIL S.A.", pageW / 2, currentY + 8, { align: "center" });
                currentY += 15; doc.line(margin, currentY, pageW - margin, currentY); currentY += 10;
                doc.setFontSize(84); doc.setFont("helvetica", "bold");
                const descLines = doc.splitTextToSize(data.descripcion, contentW);
                doc.text(descLines, pageW / 2, currentY + 28, { align: "center", lineHeightFactor: 1 });
                currentY += (descLines.length * 28) + 10;
                doc.line(margin, currentY, pageW - margin, currentY); currentY += 2;
                doc.setFontSize(20); doc.setFont("helvetica", "bold"); doc.text(`SKU: ${data.sku}`, margin, currentY + 12);
                let lotesProdString = data.lotes.join(' / ');
                if (data.hasNote) { lotesProdString += ' (*)'; } 
                if(lotesProdString) { doc.setFontSize(18); doc.setFont("helvetica", "normal"); doc.text(`Lotes: ${lotesProdString}`, pageW - margin, currentY + 12, { align: "right" }); }
                currentY += 18; doc.line(margin, currentY, pageW - margin, currentY); currentY += 8;
                const formatNumberES = (numStr) => { if (!numStr) return ''; const [integerPart, decimalPart] = numStr.split(','); const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, "."); return decimalPart !== undefined ? `${formattedInteger},${decimalPart}` : formattedInteger; };
                const formattedCantidad = formatNumberES(data.cantidad);
                const uomText = data.uom === 'Unidad' ? 'Unidades' : 'Millares';
                const cantidadString = `${formattedCantidad} ${uomText}`;
                doc.setFont("helvetica", "bold"); doc.setFontSize(44);
                const cantidadWidth = doc.getStringUnitWidth(cantidadString) * doc.getFontSize() / doc.internal.scaleFactor;
                doc.text(cantidadString, (pageW - cantidadWidth) / 2, currentY + 12); currentY += 20;
                const qrSize = 90; const qrX = (pageW - qrSize) / 2; const qrY = currentY;
                const qrImageData = await QRCode.toDataURL(data.qrString, { width: 400, margin: 2, errorCorrectionLevel: 'M' });
                doc.addImage(qrImageData, 'PNG', qrX, qrY, qrSize, qrSize); currentY += qrSize + 5;
                doc.line(margin, currentY, pageW - margin, currentY); currentY += 5;
                doc.setFontSize(22); doc.setFont("helvetica", "bold"); doc.text("Nº de Pallet", margin, currentY + 10); doc.text("Fabricación", pageW - margin, currentY + 10, { align: "right" });
                doc.setFontSize(36); doc.text(String(data.palletId), margin, currentY + 22);
                doc.setFontSize(22);
                const [day, month, year] = data.fechaProd.split('/');
                doc.text(new Date(year, month - 1, day).toLocaleDateString('es-ES'), pageW - margin, currentY + 22, { align: "right" });
                
                let yPos = currentY + 35;

                if (data.rnpa && data.rnpa.trim() !== '') {
                    doc.setFontSize(20);
                    doc.setFont("helvetica", "normal");
                    doc.text(`RNPE: ${data.rnpa}`, margin, yPos);
                }

                if (data.rne && data.rne.trim() !== '') {
                    doc.setFontSize(20);
                    doc.setFont("helvetica", "normal");
                    doc.text(`RNE: ${data.rne}`, pageW - margin, yPos, { align: "right" });
                }
            };

            const handleReprint = async (item) => {
                const { data: articles, error } = await supabaseClient.from('articulos').select('descripcioncorta, rne, rnpa').eq('sku', item.sku).single();
                if(error) {
                    alert("No se pudo obtener la descripción corta, RNE y RNPA del artículo para la reimpresión.");
                    console.error(error);
                    return;
                }

                const cantidadParaQR = String(item.cantidad).replace(',', '.');
                const qrString = [ item.sku, item.descripcion, item.numeroDePallet, item.lotesProduccion, item.fechaProduccion, cantidadParaQR, item.unidadMedida ].join(';');
                
                const descripcionParaEtiqueta = articles.descripcioncorta || item.descripcion;

                const data = { 
                    sku: item.sku, 
                    descripcion: descripcionParaEtiqueta, 
                    lotes: item.lotesProduccion.split('#').filter(Boolean), 
                    cantidad: String(item.cantidad), 
                    uom: item.unidadMedida, 
                    fechaProd: item.fechaProduccion, 
                    palletId: item.numeroDePallet, 
                    qrString: qrString, 
                    hasNote: item.hasNote,
                    rne: articles.rne,
                    rnpa: articles.rnpa
                };
                const previewDoc = new jsPDF('p', 'mm', 'a4'); await drawLabelOnDoc(previewDoc, data);
                const printDoc = new jsPDF('p', 'mm', 'a4'); await drawLabelOnDoc(printDoc, data);
                printDoc.autoPrint();
                setReprintModal({ isOpen: true, pdfUrl: previewDoc.output('datauristring'), printablePdfUrl: printDoc.output('bloburl'), palletId: item.numeroDePallet });
            };

            const ActionModal = ({ isOpen, type, title, message, onConfirm, onClose }) => {
                if (!isOpen) return null;
                const [inputValue, setInputValue] = useState('');
                const inputRef = useRef(null);
                useEffect(() => { if (isOpen) setTimeout(() => inputRef.current?.focus(), 100); }, [isOpen]);
                const handleConfirm = () => onConfirm(inputValue);
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                            <p className="text-sm text-gray-600 mb-4">{message}</p>
                            {(type === 'text' || type === 'password') && (
                                <input ref={inputRef} type={type} value={inputValue} onChange={e => setInputValue(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleConfirm()} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" autoComplete="off" />
                            )}
                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onClose} className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button onClick={handleConfirm} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Aceptar</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ObservationModal = ({ isOpen, text, onClose }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Observación del Lote</h3>
                            <p className="text-base text-gray-700 mb-6 whitespace-pre-wrap">{text}</p>
                            <div className="flex justify-end"><button onClick={onClose} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Cerrar</button></div>
                        </div>
                    </div>
                );
            };

            const ReprintModal = ({ isOpen, pdfUrl, printablePdfUrl, palletId, onClose }) => {
                if (!isOpen) return null;
                const handlePrint = () => { if (printablePdfUrl) { window.open(printablePdfUrl, '_blank'); } };
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl h-5/6 flex flex-col">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Reimprimir Etiqueta - Pallet Nº {palletId}</h3>
                            <div className="flex-grow border rounded-lg overflow-hidden"><iframe src={pdfUrl} className="w-full h-full" title={`Etiqueta Pallet ${palletId}`}></iframe></div>
                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onClose} className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button onClick={handlePrint} className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center"><i className="fas fa-print mr-2"></i>Imprimir</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const PendingModal = ({ isOpen, onClose, data }) => {
                if (!isOpen) return null;
                const pendingItems = data.filter(item => !item.isStored);
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                         <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-md h-4/6 flex flex-col">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Pallets Pendientes de Transferencia</h3>
                            <div className="flex-grow border rounded-lg overflow-y-auto p-2">
                                <ul className="divide-y divide-gray-200">
                                    {pendingItems.length > 0 ? pendingItems.map(item => (
                                        <li key={item.id} className="py-2 px-3 text-sm">
                                            <span className="font-semibold text-gray-800">Pallet Nº: {item.numeroDePallet}</span>
                                            <span className="text-gray-600"> - SKU: {item.sku}</span>
                                        </li>
                                    )) : <p className="text-gray-500 p-4 text-center">No hay pallets pendientes.</p>}
                                </ul>
                            </div>
                            <div className="flex justify-end mt-4">
                                <button onClick={onClose} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Cerrar</button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const HelpModal = ({ onClose }) => ( 
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-3xl h-5/6 flex flex-col">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Guía de Usuario</h3>
                        <div className="flex-grow overflow-y-auto pr-2 space-y-6 text-gray-700">
                            <div>
                                <h4 className="font-bold text-lg text-indigo-700">Funciones Básicas</h4>
                                <ul className="list-disc list-inside mt-2 space-y-1">
                                    <li><strong>Filtrado:</strong> Puedes filtrar los datos por cualquier columna usando los campos de texto debajo de los encabezados. También puedes filtrar por rango de fechas.</li>
                                    <li><strong>Limpiar Filtros:</strong> El botón "Limpiar Filtros" borra todas las búsquedas y fechas.</li>
                                    <li><strong>Refrescar:</strong> Recarga todos los datos directamente desde la base de datos.</li>
                                    <li><strong>Exportar:</strong> Permite descargar la vista actual de la tabla en formato PDF o Excel.</li>
                                    <li><strong>Observaciones:</strong> Las filas resaltadas en amarillo claro tienen una nota. Haz doble clic o una pulsación larga en la fila para ver la observación.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 className="font-bold text-lg text-indigo-700">Gestión de Notas</h4>
                                <ul className="list-disc list-inside mt-2 space-y-1">
                                    <li><strong>Agregar/Editar:</strong> En el menú de acciones (<i className="fas fa-ellipsis-v"></i>), selecciona "Agregar Nota" o "Editar/Ver Nota". Se abrirá una ventana para que escribas.</li>
                                    <li><strong>Visualizar:</strong> Las filas con notas aparecen resaltadas en amarillo y el número de pallet tiene un asterisco (*). Puedes ver la nota haciendo doble clic en la fila.</li>
                                    <li><strong>Eliminar:</strong> Para borrar una nota, ábrela para editarla y simplemente guarda el campo de texto vacío.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 className="font-bold text-lg text-indigo-700">Modo Transferencia</h4>
                                <ul className="list-disc list-inside mt-2 space-y-1">
                                    <li><strong>Activar:</strong> Usa el botón "Modo Transferencia" para empezar a seleccionar pallets.</li>
                                    <li><strong>Selección:</strong> Haz clic en las filas para seleccionar/deseleccionar los pallets a transferir.</li>
                                    <li><strong>Confirmar:</strong> Al confirmar la transferencia, se descargará automáticamente un <strong>reporte en PDF</strong> con el detalle y resumen de los pallets transferidos.</li>
                                </ul>
                            </div>
                        </div>
                        <div className="flex justify-end mt-6"><button onClick={onClose} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Cerrar</button></div>
                    </div>
                </div>
            );

            const handleSelectAll = () => {
                const allVisibleIds = allData.map(item => item.id);
                const allSelectedOnPage = allVisibleIds.length > 0 && allVisibleIds.every(id => transferSelection[id]);
                
                setTransferSelection(prev => {
                    const newSelection = {...prev};
                    if (allSelectedOnPage) {
                        allVisibleIds.forEach(id => { delete newSelection[id]; });
                    } else {
                        allVisibleIds.forEach(id => { newSelection[id] = true; });
                    }
                    return newSelection;
                });
            };

            const TransferBar = () => {
                if (!isTransferMode) return null;
                const selectionCount = Object.values(transferSelection).filter(Boolean).length;
                return (
                    <div className="bg-indigo-600 text-white p-4 rounded-lg mb-4 shadow-lg flex justify-between items-center">
                        <h2 className="text-xl font-bold">Modo Transferencia</h2>
                        <div className="flex items-center space-x-4">
                            <span className="font-semibold">{selectionCount} pallet(s) seleccionado(s)</span>
                            <button onClick={handleSelectAll} className="bg-indigo-400 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg"><i className="fas fa-check-double mr-2"></i>Tildar/Destildar Página</button>
                            <button onClick={handleConfirmTransfer} disabled={selectionCount === 0} className="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50"><i className="fas fa-check mr-2"></i>Confirmar Transferencia</button>
                            <button onClick={handleCancelTransferMode} className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg"><i className="fas fa-times mr-2"></i>Cancelar</button>
                        </div>
                    </div>
                );
            };

            const NotificationBanner = () => {
                if (!newDataAvailable) return null;

                return (
                    <div className="bg-blue-500 text-white p-3 text-center rounded-lg shadow-lg mb-4 flex justify-center items-center">
                        <i className="fas fa-info-circle mr-3"></i>
                        <span>Hay nuevos registros o actualizaciones disponibles.</span>
                        <button onClick={() => loadData(true)} className="ml-4 bg-white text-blue-500 font-bold py-1 px-3 rounded-lg hover:bg-blue-100">
                            Refrescar Ahora
                        </button>
                    </div>
                );
            };
            
            if (appIsLoading) {
                return null; 
            }

            return (
                <div className="min-h-screen p-4 sm:p-6 bg-black bg-opacity-50 flex flex-col">
                    <NotificationBanner />
                    {isSaving && (
                        <div className="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
                            <div className="flex items-center space-x-3 text-xl font-semibold text-gray-700"><i className="fas fa-sync-alt animate-spin"></i><span>Guardando...</span></div>
                        </div>
                    )}
                    <ActionModal isOpen={modalState.isOpen} type={modalState.type} title={modalState.title} message={modalState.message} onClose={() => setModalState({ isOpen: false })} onConfirm={modalState.onConfirm} />
                    <ObservationModal isOpen={observationModal.isOpen} text={observationModal.text} onClose={() => setObservationModal({ isOpen: false, text: '' })} />
                    <NoteModal 
                        isOpen={noteModal.isOpen}
                        text={noteModal.text}
                        onClose={() => setNoteModal({ isOpen: false, item: null, text: '' })}
                        onSave={handleSaveNote}
                    />
                    <ReprintModal isOpen={reprintModal.isOpen} pdfUrl={reprintModal.pdfUrl} printablePdfUrl={reprintModal.printablePdfUrl} palletId={reprintModal.palletId} onClose={() => setReprintModal({ isOpen: false, pdfUrl: null, printablePdfUrl: null, palletId: null })} />
                    <PendingModal isOpen={showPendingModal} onClose={() => setShowPendingModal(false)} data={allData} />
                    {showHelpModal && <HelpModal onClose={() => setShowHelpModal(false)} />}
                    
                    <div className="bg-white p-6 rounded-2xl shadow-xl flex flex-col flex-grow md:overflow-hidden">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-gray-200">
                            <div className="flex items-center space-x-4">
                                <h1 className="text-3xl font-extrabold text-gray-800">Histórico de Lotes</h1>
                                <button onClick={() => setShowHelpModal(true)} title="Ayuda" className="text-gray-400 hover:text-indigo-600 transition-colors"><i className="fas fa-question-circle text-2xl"></i></button>
                            </div>
                            <div className="flex items-center space-x-3 mt-4 sm:mt-0 relative" ref={mobileMenuRef}>
                                {/* Hamburger button for mobile */}
                                <div className="sm:hidden">
                                    <button onClick={() => setIsMobileMenuOpen(prev => !prev)} className="text-gray-500 hover:text-gray-600 focus:outline-none focus:text-gray-600">
                                        <i className="fas fa-bars text-2xl"></i>
                                    </button>
                                </div>

                                {/* Desktop buttons */}
                                <div className="hidden sm:flex sm:items-center sm:space-x-3">
                                    {!isTransferMode && (
                                        <button onClick={handleEnterTransferMode} className="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm flex items-center"><i className="fas fa-truck mr-2"></i>Modo Transferencia</button>
                                    )}
                                    <button onClick={() => setShowPendingModal(true)} className="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm flex items-center"><i className="fas fa-pallet mr-2"></i>Pendientes de Transferencia</button>
                                    <a href="posiciones3d.html" className="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors shadow-sm flex items-center"><i className="fas fa-cubes mr-2"></i>Ubicaciones 3D</a>
                                    <a href="histolistaempaque.html" className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors shadow-sm flex items-center"><i className="fas fa-history mr-2"></i>Histórico Empaque</a>
                                    <a href="generarqr.html" className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-sm flex items-center"><i className="fas fa-plus mr-2"></i>Generar Nuevo</a>
                                    <a href="index.html" className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Volver al Menú</a>
                                </div>
                                
                                {/* Mobile menu */}
                                {isMobileMenuOpen && (
                                    <div className="sm:hidden absolute top-10 right-0 mt-2 w-64 bg-white rounded-md shadow-lg border z-40">
                                        <div className="flex flex-col space-y-2 p-2">
                                            {!isTransferMode && (
                                                <button onClick={() => { handleEnterTransferMode(); setIsMobileMenuOpen(false); }} className="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm flex items-center justify-center"><i className="fas fa-truck mr-2"></i>Modo Transferencia</button>
                                            )}
                                            <button onClick={() => { setShowPendingModal(true); setIsMobileMenuOpen(false); }} className="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm flex items-center justify-center"><i className="fas fa-pallet mr-2"></i>Pendientes</button>
                                            <a href="posiciones3d.html" className="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors shadow-sm flex items-center justify-center"><i className="fas fa-cubes mr-2"></i>Ubicaciones 3D</a>
                                            <a href="histolistaempaque.html" className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors shadow-sm flex items-center justify-center"><i className="fas fa-history mr-2"></i>Hist. Empaque</a>
                                            <a href="generarqr.html" className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-sm flex items-center justify-center"><i className="fas fa-plus mr-2"></i>Generar Nuevo</a>
                                            <a href="index.html" className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center justify-center">Volver al Menú</a>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <TransferBar />

                        <div class="flex justify-between items-center mb-4 p-4 border rounded-lg bg-gray-50">
                            <div class="flex items-center space-x-4">
                                {!isTransferMode && (
                                    <>
                                        <div class="flex items-center space-x-2">
                                            <label class="text-sm font-medium text-gray-700">Desde:</label>
                                            <input type="date" value={fechaDesde} onChange={e => setFechaDesde(e.target.value)} className="rounded-md border-gray-300 shadow-sm p-2 border"/>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="text-sm font-medium text-gray-700">Hasta:</label>
                                            <input type="date" value={fechaHasta} onChange={e => setFechaHasta(e.target.value)} className="rounded-md border-gray-300 shadow-sm p-2 border"/>
                                        </div>
                                    </>
                                )}
                                <button onClick={clearFilters} className="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 flex items-center"><i className="fas fa-times-circle mr-2"></i>Limpiar Filtros</button>

                            </div>

                            <div className="flex items-center space-x-4">
                                <p className="text-gray-600 font-semibold">{totalRecords} registro(s) encontrado(s)</p>
                                
                                <div className="flex items-center space-x-2">
                                    <label htmlFor="recordsPerPage" className="text-sm font-medium text-gray-700">Ver:</label>
                                    <select id="recordsPerPage" value={recordsPerPage} onChange={e => { setRecordsPerPage(Number(e.target.value)); }} className="rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                        <option value={50}>50</option>
                                        <option value={100}>100</option>
                                        <option value={200}>200</option>
                                        <option value={400}>400</option>
                                    </select>
                                </div>

                                <div className="flex items-center space-x-1">
                                    <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1 || appIsLoading} className="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-3 rounded-lg shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i className="fas fa-chevron-left"></i>
                                    </button>
                                    <span className="text-sm font-medium text-gray-700 px-2">
                                        Página {currentPage} de {totalRecords > 0 ? Math.ceil(totalRecords / recordsPerPage) : 1}
                                    </span>
                                    <button onClick={() => setCurrentPage(p => p + 1)} disabled={currentPage * recordsPerPage >= totalRecords || appIsLoading} className="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-3 rounded-lg shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i className="fas fa-chevron-right"></i>
                                    </button>
                                </div>

                                <button onClick={() => loadData(true)} disabled={appIsLoading || isSaving} className="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50 flex items-center"><i className={`fas fa-sync-alt ${appIsLoading ? 'animate-spin' : ''} mr-2`}></i>Refrescar</button>
                                <div className="relative" ref={exportMenuRef}>
                                    <button onClick={() => setIsExportOpen(prev => !prev)} disabled={totalRecords === 0} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 flex items-center"><i className="fas fa-download mr-2"></i>Exportar<i className={`fas fa-chevron-down ml-2 transition-transform ${isExportOpen ? 'rotate-180' : ''}`}></i></button>
                                    {isExportOpen && (
                                        <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-20">
                                            <ul className="text-gray-700">
                                                <li><button onClick={exportToPDF} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-pdf w-6 mr-2 text-red-500"></i>Exportar a PDF</button></li>
                                                <li><button onClick={exportToExcel} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-excel w-6 mr-2 text-green-500"></i>Exportar a Excel</button></li>
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="relative overflow-auto rounded-lg shadow-md border flex-grow min-h-0">
                            {isGridLoading && (
                                <div className="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-20">
                                    <div className="flex items-center space-x-3 text-xl font-semibold text-gray-700 bg-white p-4 rounded-lg shadow-lg">
                                        <i className="fas fa-sync-alt animate-spin"></i>
                                        <span>Filtrando...</span>
                                    </div>
                                </div>
                            )}
                            <table className={`min-w-full divide-y divide-gray-200 ${isGridLoading ? 'opacity-50' : ''}`}>
                                <thead className="bg-gray-800 text-white sticky top-0 z-10">
                                    <tr>
                                        <th className="px-1 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('isStored')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Almacenado</span>
                                                {sortConfig.key === 'isStored' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('sku')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>SKU</span>
                                                {sortConfig.key === 'sku' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('descripcion')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Descripción</span>
                                                {sortConfig.key === 'descripcion' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('numeroDePallet')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Nº Pallet</span>
                                                {sortConfig.key === 'numeroDePallet' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('lotesProduccion')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Lotes Prod.</span>
                                                {sortConfig.key === 'lotesProduccion' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('despachado')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Despachado</span>
                                                {sortConfig.key === 'despachado' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('cliente')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Cliente</span>
                                                {sortConfig.key === 'cliente' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('fechaProduccion')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>F. Prod.</span>
                                                {sortConfig.key === 'fechaProduccion' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('cantidad')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>Cantidad</span>
                                                {sortConfig.key === 'cantidad' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                            <button onClick={() => requestSort('unidadMedida')} className="flex items-center space-x-1 hover:text-gray-300">
                                                <span>U.M.</span>
                                                {sortConfig.key === 'unidadMedida' ? (
                                                    sortConfig.direction === 'ascending' ? <i className="fas fa-sort-up"></i> : <i className="fas fa-sort-down"></i>
                                                ) : <i className="fas fa-sort text-gray-500"></i>}
                                            </button>
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Acciones</th>
                                    </tr>
                                    <tr class="bg-gray-200">
                                        <th className="p-1"></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={internalColumnFilters.sku} onChange={e => handleColumnFilterChange('sku', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded" /></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={internalColumnFilters.descripcion} onChange={e => handleColumnFilterChange('descripcion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded" /></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={internalColumnFilters.numeroDePallet} onChange={e => handleColumnFilterChange('numeroDePallet', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded" /></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={internalColumnFilters.lotesProduccion} onChange={e => handleColumnFilterChange('lotesProduccion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded" /></th>
                                        <th className="p-1"><input type="text" placeholder="Sí / No" value={internalColumnFilters.despachado} onChange={e => handleColumnFilterChange('despachado', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded" /></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={internalColumnFilters.cliente} onChange={e => handleColumnFilterChange('cliente', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded" /></th>
                                        <th colSpan="4" className="p-1"></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {allData.length > 0 ? allData.map((item) => {
                                            const isDespachado = item.despachado;

                                            const clients = item.cliente ? item.cliente.split('#').filter(Boolean) : [];

                                            const noteAction = () => {
                                                if (item.hasNote) {
                                                    setObservationModal({ isOpen: true, text: item.noteText });
                                                }
                                            };

                                            let rowClassName = 'transition-colors';
                                            if (isTransferMode) {
                                                rowClassName += ' cursor-pointer';
                                                if (transferSelection[item.id]) {
                                                    rowClassName += ' bg-indigo-100 hover:bg-indigo-200';
                                                } else {
                                                    rowClassName += ' hover:bg-gray-100';
                                                }
                                            } else if (item.hasNote) {
                                                rowClassName += ' bg-yellow-50 hover:bg-yellow-100 cursor-pointer';
                                            } else {
                                                rowClassName += ' hover:bg-gray-50';
                                            }

                                            const handleRowClick = () => {
                                                if (isTransferMode) {
                                                    handleToggleTransferSelection(item.id);
                                                } else {
                                                    noteAction();
                                                }
                                            };

                                            return (
                                            <tr key={item.id} className={rowClassName} 
                                                onClick={handleRowClick}
                                                onTouchStart={() => !isTransferMode && handlePressStart(noteAction)} 
                                                onTouchEnd={() => !isTransferMode && handlePressEnd()}
                                                onMouseDown={() => !isTransferMode && handlePressStart(noteAction)} 
                                                onMouseUp={() => !isTransferMode && handlePressEnd()} 
                                                onMouseLeave={() => !isTransferMode && handlePressEnd()}>
                                                <td className="px-1 py-2 text-center align-middle">
                                                    <input type="checkbox" className={`h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 ${isTransferMode ? 'cursor-pointer' : ''}`}
                                                        checked={isTransferMode ? !!transferSelection[item.id] : item.isStored}
                                                        disabled={!isTransferMode}
                                                        onChange={() => handleToggleTransferSelection(item.id)}
                                                        onClick={(e) => e.stopPropagation()}
                                                    />
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{item.sku}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.descripcion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600 font-semibold">
                                                    {item.numeroDePallet} {item.hasNote && <span className="text-red-500 ml-1">(*)</span>}
                                                </td>
                                                <td className="px-4 py-2 text-sm text-gray-600 align-middle">
                                                    {item.lotesProduccion && item.lotesProduccion.includes('#') ? (
                                                        <div className="flex flex-wrap gap-1">{item.lotesProduccion.split('#').map((lote, i) => (<span key={`${lote}-${i}`} className="px-2.5 py-0.5 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">{lote}</span>))}
                                                        </div>
                                                    ) : ( item.lotesProduccion )}
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold"><span className={isDespachado ? 'text-green-600' : 'text-red-600'}>{isDespachado ? 'Sí' : 'No'}</span></td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">
                                                    <div className="flex flex-wrap gap-1">{clients.map(client => (
                                                        <div key={client} className="relative">
                                                            <span 
                                                                className="px-2.5 py-0.5 text-xs font-semibold bg-indigo-100 text-indigo-800 rounded-full"
                                                            >
                                                                {client}
                                                            </span>
                                                        </div>))}
                                                    </div>
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.fechaProduccion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.cantidad}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.unidadMedida}</td>
                                                <td className="px-4 py-2 text-center">
                                                    <div className="relative" ref={activeActionMenu === item.id ? actionMenuRef : null}>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); setActiveActionMenu(activeActionMenu === item.id ? null : item.id); }} 
                                                            disabled={isSaving || isTransferMode}
                                                            className="text-gray-500 hover:text-blue-600 p-2 rounded-full disabled:opacity-50 disabled:cursor-not-allowed"
                                                        >
                                                            <i className="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        {activeActionMenu === item.id && (
                                                            <div className="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg border z-30">
                                                                <ul className="text-gray-700 text-left">
                                                                    <li><button onClick={(e) => { e.stopPropagation(); handleOpenNoteModal(item); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-sticky-note w-6 mr-2 text-yellow-500"></i>{item.hasNote ? 'Editar/Ver Nota' : 'Agregar Nota'}</button></li>
                                                                    <li><a href={`generarqr.html?edit=${item.numeroDePallet}`} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-edit w-6 mr-2 text-blue-500"></i>Editar</a></li>
                                                                    <li><button onClick={(e) => { e.stopPropagation(); handleReprint(item); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-print w-6 mr-2 text-blue-500"></i>Reimprimir Etiqueta</button></li>
                                                                    <li><hr className="my-1"/></li>
                                                                    <li><button onClick={(e) => { e.stopPropagation(); handleDeleteRow(item.id); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-trash-alt w-6 mr-2 text-red-500"></i>Eliminar Fila</button></li>
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            )
                                        }) : (
                                            <tr><td colSpan="11" className="px-4 py-8 text-center text-sm text-gray-500">No se encontraron registros con los filtros aplicados.</td></tr>
                                        )
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>